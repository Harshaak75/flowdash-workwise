generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String             @id @default(cuid())
  email               String             
  password            String
  role                Role
  tenantId            String
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  ManagerEmployees    Employee[]         @relation("ManagerEmployees")
  Employee            Employee?
  ExternalIdentity    ExternalIdentity[]
  kanbanIssuesCreated KanbanIssue[]      @relation("KanbanIssuesCreatedBy")
  tasksAssigned       Task[]             @relation("TasksAssignedTo")
  tasksCreated        Task[]             @relation("TasksCreatedBy")
  TaskComment         TaskComment[]
  taskWorkLogs        TaskWorkLog[]
  attendances         UserAttendance[]   @relation("UserAttendances")
  generatedReports Report[] @relation("UserGeneratedReports")
  employeeReportSnapshots EmployeeReportSnapshot[]

  @@unique([email, tenantId])
}

model Employee {
  id         String   @id @default(cuid())
  userId     String   @unique
  tenantId   String
  name       String
  roleTitle  String
  department String?
  status     String   @default("Active")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  managerId  String?
  manager    User?    @relation("ManagerEmployees", fields: [managerId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id               String        @id @default(cuid())
  title            String
  tenantId         String
  notes            String?
  dueDate          DateTime?
  priority         TaskPriority  @default(MEDIUM)
  status           TaskStatus    @default(TODO)
  assignedHours    Int?
  completedAt      DateTime?
  createdById      String?
  assigneeId       String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  fileUrl_manager  String?
  fileUrl_operator String?
  isDeleted        Boolean       @default(false)
  assignee         User?         @relation("TasksAssignedTo", fields: [assigneeId], references: [id])
  createdBy        User?         @relation("TasksCreatedBy", fields: [createdById], references: [id])
  TaskComment      TaskComment[]
  taskWorkLogs     TaskWorkLog[]

  @@index([assigneeId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
  @@index([tenantId])
  @@index([tenantId, assigneeId])
}

model TaskWorkLog {
  id        String    @id @default(cuid())
  tenantId  String?
  taskId    String
  userId    String
  isAutoPaused Boolean @default(false)
  startTime DateTime
  endTime   DateTime?
  createdAt DateTime  @default(now())
  task      Task      @relation(fields: [taskId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, endTime])
}

model TaskComment {
  id             String   @id @default(cuid())
  taskId         String
  authorId       String
  tenantId       String?
  content        String
  seenByAssignee Boolean  @default(false)
  seenByManager  Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  author         User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  task           Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}

model ExternalIdentity {
  id        String   @id @default(cuid())
  provider  String? // "keycloak"
  subject   String  // Keycloak `sub`
  email     String
  tenantId  String
  userId    String?

  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([email, tenantId])
  @@unique([provider, subject, tenantId])
}

model UserAttendance {
  id                  String     @id @default(cuid())
  userId              String
  workDate            DateTime   @db.Date
  loginTime           DateTime
  logoutTime          DateTime?
  breakStartTime      DateTime?
  breakEndTime        DateTime?
  totalBreakMinutes   Int        @default(0)
  totalWorkingMinutes Int?
  isActiveSession     Boolean    @default(true)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  breakLogs           BreakLog[] @relation("AttendanceBreakLogs")
  user                User       @relation("UserAttendances", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, workDate])
  @@index([userId])
  @@index([workDate])
}

model BreakLog {
  id           String         @id @default(cuid())
  attendanceId String
  breakStart   DateTime
  breakEnd     DateTime?
  createdAt    DateTime       @default(now())
  attendance   UserAttendance @relation("AttendanceBreakLogs", fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
}

model KanbanBoard {
  id         String         @id @default(cuid())
  name       String
  tenantId   String
  scope      String         @default("GLOBAL")
  department String?        // Department this board belongs to (null for PROJECT_MANAGER's personal board)
  ownerId    String?        // User ID of the board owner (PROJECT_MANAGER or MANAGER)
  createdAt  DateTime       @default(now())
  columns    KanbanColumn[]
  
  @@index([tenantId, department])
  @@index([ownerId])
}

model KanbanColumn {
  id        String        @id @default(cuid())
  title     String
  order     Int
  boardId   String
  createdAt DateTime      @default(now())
  board     KanbanBoard   @relation(fields: [boardId], references: [id], onDelete: Cascade)
  issues    KanbanIssue[]

  @@index([boardId])
}

model KanbanIssue {
  id           String       @id @default(cuid())
  title        String
  priority     TaskPriority @default(MEDIUM)
  tenantId     String
  estimate     String?
  assigneeName String?
  columnId     String
  createdBy    String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  column       KanbanColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  creator      User         @relation("KanbanIssuesCreatedBy", fields: [createdBy], references: [id])

  @@index([columnId])
}

enum Role {
  MANAGER
  OPERATOR
  PROJECT_MANAGER
}

enum TaskStatus {
  TODO
  WORKING
  STUCK
  DONE
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum ReportStatus {
  GENERATING
  READY
  FAILED
}


model Report {
  id          String      @id @default(cuid())
  tenantId    String
  type        ReportType
  scope       ReportScope
  generatedBy String
  fromDate    DateTime
  toDate      DateTime
  pdfUrl      String?
  excelUrl    String?
  createdAt   DateTime    @default(now())
  status      ReportStatus  @default(GENERATING)

  generator   User        @relation("UserGeneratedReports", fields: [generatedBy], references: [id])
  snapshots   EmployeeReportSnapshot[]
}

model EmployeeReportSnapshot {
  id              String   @id @default(cuid())
  reportId        String
  userId          String
  tenantId        String

  totalTasks      Int
  completedTasks  Int
  todoTasks       Int
  workingTasks    Int
  doneTasks       Int

  completionRate  Int
  totalHours      Int
  avgDailyHours   Float
  productivityScore Int

  pdfUrl          String?
  excelUrl        String?

  fromDate        DateTime
  toDate          DateTime

  createdAt       DateTime @default(now())

  report          Report   @relation(fields: [reportId], references: [id])
  user            User     @relation(fields: [userId], references: [id])

  @@unique([reportId, userId])
  @@index([reportId])
  @@index([userId])
}



enum ReportType {
  WEEKLY
  MONTHLY
  EMPLOYEE
  CUSTOM
}

enum ReportScope {
  TEAM
  EMPLOYEE
  DEPARTMENT
}
